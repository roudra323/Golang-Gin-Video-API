<!DOCTYPE html>
<html>

<head>
    <title>Video API + Socket.IO Client</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ccc;
            border-radius: 5px;
        }

        .connected {
            border-color: green;
            background: #e8f5e8;
        }

        .disconnected {
            border-color: red;
            background: #ffeaea;
        }

        .connecting {
            border-color: orange;
            background: #fff4e6;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .video-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .video-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .video-card.new {
            border-color: #28a745;
            background: #f8fff8;
            animation: highlight 2s ease-out;
        }

        @keyframes highlight {
            0% {
                background: #90EE90;
            }

            100% {
                background: #f8fff8;
            }
        }

        .video-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .video-url {
            color: #007acc;
            text-decoration: none;
            word-break: break-all;
        }

        .video-url:hover {
            text-decoration: underline;
        }

        .video-id {
            color: #666;
            font-size: 12px;
            margin-top: 8px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button:hover:not(:disabled) {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .logs {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #007acc;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üé• Video API + Socket.IO Real-time Client</h1>

        <!-- Connection Status -->
        <div class="section">
            <div id="status" class="status connecting">‚è≥ Connecting to server...</div>
            <div id="version" style="color: #666; font-size: 12px; margin-top: 10px;"></div>
        </div>

        <!-- Statistics -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="videoCount">0</div>
                <div class="stat-label">Total Videos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newVideosCount">0</div>
                <div class="stat-label">New This Session</div>
            </div>
        </div>

        <!-- Add Video Form -->
        <div class="section">
            <h3>üì§ Add New Video</h3>
            <div class="form-section">
                <div class="form-group">
                    <label for="videoTitle">Video Title:</label>
                    <input type="text" id="videoTitle" placeholder="Enter video title..." />
                </div>
                <div class="form-group">
                    <label for="videoUrl">Video URL:</label>
                    <input type="url" id="videoUrl" placeholder="https://example.com/video.mp4" />
                </div>
                <button onclick="addVideo()" class="btn-success" id="addBtn" disabled>üé¨ Add Video</button>
                <button onclick="loadVideos()">üîÑ Refresh Videos</button>
            </div>
        </div>

        <!-- Videos Display -->
        <div class="section">
            <h3>üé¨ Videos (<span id="videoCountDisplay">0</span>)</h3>
            <div id="videosContainer">
                <div class="empty-state">üîÑ Loading videos...</div>
            </div>
        </div>

        <!-- Debug Logs -->
        <div class="section">
            <h3>üîß Debug Logs</h3>
            <div id="logs" class="logs">
                <strong>Logs:</strong><br>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const statusDiv = document.getElementById('status');
        const versionDiv = document.getElementById('version');
        const logsDiv = document.getElementById('logs');
        const videosContainer = document.getElementById('videosContainer');
        const addBtn = document.getElementById('addBtn');
        const videoCountEl = document.getElementById('videoCount');
        const videoCountDisplayEl = document.getElementById('videoCountDisplay');
        const newVideosCountEl = document.getElementById('newVideosCount');

        // State
        let socket = null;
        let videos = [];
        let newVideosThisSession = 0;

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#007acc',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };

            logsDiv.innerHTML += `<div style="color: ${colors[type]}; margin: 2px 0;">
                [${timestamp}] ${message}
            </div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Load videos from API
        async function loadVideos() {
            try {
                log('üì° Loading videos from API...', 'info');
                const response = await fetch('http://localhost:8080/videos');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                videos = data || [];

                log(`‚úÖ Loaded ${videos.length} videos`, 'success');
                updateVideoStats();
                displayVideos();

            } catch (error) {
                log(`‚ùå Failed to load videos: ${error.message}`, 'error');
                videosContainer.innerHTML = `<div class="empty-state">‚ùå Failed to load videos: ${error.message}</div>`;
            }
        }

        // Display videos in grid
        function displayVideos() {
            if (videos.length === 0) {
                videosContainer.innerHTML = '<div class="empty-state">üì≠ No videos found. Add some videos!</div>';
                return;
            }

            const videosHTML = videos.map(video => `
                <div class="video-card" data-video-id="${video.ID}">
                    <div class="video-title">${escapeHtml(video.Title)}</div>
                    <a href="${escapeHtml(video.URL)}" target="_blank" class="video-url">${escapeHtml(video.URL)}</a>
                    <div class="video-id">ID: ${video.ID}</div>
                </div>
            `).join('');

            videosContainer.innerHTML = `<div class="video-grid">${videosHTML}</div>`;
        }

        // Add new video
        async function addVideo() {
            const title = document.getElementById('videoTitle').value.trim();
            const url = document.getElementById('videoUrl').value.trim();

            if (!title || !url) {
                alert('Please fill in both title and URL');
                return;
            }

            try {
                log(`üì§ Adding video: ${title}`, 'info');

                const response = await fetch('http://localhost:8080/videos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        Title: title,
                        URL: url
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const newVideo = await response.json();
                log(`‚úÖ Video added successfully: ID ${newVideo.ID}`, 'success');

                // Clear form
                document.getElementById('videoTitle').value = '';
                document.getElementById('videoUrl').value = '';

                // Reload videos to show the new one
                loadVideos();

            } catch (error) {
                log(`‚ùå Failed to add video: ${error.message}`, 'error');
                alert(`Failed to add video: ${error.message}`);
            }
        }

        // Update statistics
        function updateVideoStats() {
            videoCountEl.textContent = videos.length;
            videoCountDisplayEl.textContent = videos.length;
            newVideosCountEl.textContent = newVideosThisSession;
        }

        // Highlight new video
        function highlightNewVideo(videoId) {
            setTimeout(() => {
                const videoCard = document.querySelector(`[data-video-id="${videoId}"]`);
                if (videoCard) {
                    videoCard.classList.add('new');
                    setTimeout(() => videoCard.classList.remove('new'), 3000);
                }
            }, 100);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Socket.IO Connection Setup
        function startSocketConnection() {
            if (typeof io === 'undefined') {
                log('‚ùå Socket.IO library not loaded!', 'error');
                statusDiv.innerHTML = '‚ùå Socket.IO library failed to load';
                statusDiv.className = 'status disconnected';
                return;
            }

            log('üöÄ Socket.IO library loaded successfully!', 'success');
            log('Starting connection to http://localhost:8080...', 'info');

            // Create socket connection
            socket = io('http://localhost:8080', {
                transports: ['polling', 'websocket'],
                upgrade: true,
                timeout: 10000,
                forceNew: true
            });

            // Connection events
            socket.on('connect', () => {
                log('üéâ Connected! Socket ID: ' + socket.id, 'success');
                statusDiv.innerHTML = '‚úÖ Connected! ID: ' + socket.id;
                statusDiv.className = 'status connected';
                versionDiv.textContent = `Client: Socket.IO v${socket.io.version || '2.4.0'} | Server: go-socket.io v1.7.0`;
                addBtn.disabled = false;

                // Load videos when connected
                loadVideos();
            });

            socket.on('connect_error', (error) => {
                log('‚ùå Connection error: ' + error, 'error');
                statusDiv.innerHTML = '‚ùå Connection Error: ' + error;
                statusDiv.className = 'status disconnected';
                addBtn.disabled = true;
            });

            socket.on('disconnect', (reason) => {
                log('üî¥ Disconnected: ' + reason, 'warning');
                statusDiv.innerHTML = 'üî¥ Disconnected: ' + reason;
                statusDiv.className = 'status connecting';
                addBtn.disabled = true;
            });

            // Real-time video events
            socket.on('video_added', (videoData) => {
                log(`üì∫ New video added: ${videoData.Title} (ID: ${videoData.ID})`, 'success');

                // Add to local array
                videos.push(videoData);
                newVideosThisSession++;

                // Update display
                updateVideoStats();
                displayVideos();
                highlightNewVideo(videoData.ID);
            });

            socket.on('video_updated', (videoData) => {
                log(`üìù Video updated: ID ${videoData.ID}`, 'info');
                loadVideos(); // Reload to get latest data
            });

            socket.on('video_deleted', (videoId) => {
                log(`üóëÔ∏è Video deleted: ID ${videoId}`, 'warning');
                videos = videos.filter(v => v.ID !== videoId);
                updateVideoStats();
                displayVideos();
            });

            // Debug: log all events
            socket.onAny((eventName, ...args) => {
                if (!['connect', 'disconnect', 'connect_error'].includes(eventName)) {
                    log(`üì° Event '${eventName}': ${JSON.stringify(args)}`, 'info');
                }
            });
        }

        // Load Socket.IO with CDN fallback
        function loadSocketIO() {
            const cdnUrls = [
                'https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.4.0/socket.io.js',
                'https://cdn.socket.io/2.4.0/socket.io.js',
                'https://unpkg.com/socket.io-client@2.4.0/dist/socket.io.js'
            ];

            let currentCDN = 0;

            function tryLoadCDN() {
                if (currentCDN >= cdnUrls.length) {
                    log('‚ùå All CDN attempts failed. Download manually?', 'error');
                    statusDiv.innerHTML = '‚ùå Socket.IO library failed to load from all CDNs';
                    statusDiv.className = 'status disconnected';
                    return;
                }

                const script = document.createElement('script');
                script.src = cdnUrls[currentCDN];

                script.onload = function () {
                    log('‚úÖ Socket.IO loaded from: ' + cdnUrls[currentCDN], 'success');
                    startSocketConnection();
                };

                script.onerror = function () {
                    log('‚ùå Failed to load from: ' + cdnUrls[currentCDN], 'error');
                    currentCDN++;
                    tryLoadCDN();
                };

                document.head.appendChild(script);
                log('üîÑ Trying to load Socket.IO from: ' + cdnUrls[currentCDN], 'info');
            }

            tryLoadCDN();
        }

        // Event listeners
        document.getElementById('videoTitle').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('videoUrl').focus();
            }
        });

        document.getElementById('videoUrl').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                addVideo();
            }
        });

        // Initialize
        log('üöÄ Starting Video API client...', 'info');
        loadSocketIO();
    </script>
</body>

</html>